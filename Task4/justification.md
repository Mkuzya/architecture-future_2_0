# Обоснование конфигурации Terraform

## Выбор ресурсов

### VPC и подсети

**VPC (10.0.0.0/16)**
- Обеспечивает изоляцию сетевой инфраструктуры
- Позволяет организовать подсети для разных доменов
- Базовая единица сетевой безопасности

**Public Subnet (10.0.1.0/24)**
- Для компонентов, требующих прямого доступа из интернета
- Portal и API Gateway размещены в публичной подсети
- NAT Gateway для обеспечения доступа в интернет

**Private Subnets (10.0.2.0/24, 10.0.3.0/24, 10.0.4.0/24)**
- Изоляция внутренних сервисов от интернета
- Разделение по доменам для дополнительной безопасности
- Доступ в интернет через NAT Gateway

### Виртуальные машины

**Portal VM (2 vCPU, 4GB RAM)**
- Лёгкая нагрузка - веб-интерфейс для пользователей
- Достаточно ресурсов для обработки запросов пользователей
- Размещение в публичной подсети для доступа из интернета

**API Gateway VM (2 vCPU, 4GB RAM)**
- Маршрутизация запросов, не требует больших ресурсов
- Размещение в публичной подсети как единая точка входа
- Масштабирование при необходимости

**ETL VM (4 vCPU, 8GB RAM)**
- Обработка больших объёмов данных требует больше ресурсов
- Размещение в приватной подсети для безопасности
- Достаточно ресурсов для параллельной обработки

**Fintech VM (4 vCPU, 8GB RAM)**
- Финансовые операции требуют стабильной работы
- Размещение в приватной подсети для безопасности
- Изоляция от других доменов

**AI Services VM (4 vCPU, 8GB RAM)**
- Обучение моделей и анализ данных требуют больших ресурсов
- Размещение в приватной подсети
- Ресурсы уменьшены из-за квот, но достаточны для базовых задач
- Возможность масштабирования при увеличении квот

**Data Mart VM (2 vCPU, 4GB RAM)**
- Аналитические запросы требуют большого объёма памяти
- Размещение в приватной подсети
- Ресурсы уменьшены до минимума из-за квот на vCPU
- Минимальная конфигурация для standard-v2 платформы

**Legacy DWH VM (2 vCPU, 8GB RAM)**
- Большие объёмы данных и сложные запросы
- Размещение в приватной подсети
- Ресурсы уменьшены из-за квот, но достаточны для базовой работы

**Event Bus VM (2 vCPU, 4GB RAM)**
- Обработка сообщений, не требует больших ресурсов
- Размещение в приватной подсети
- Масштабирование через горизонтальное масштабирование

### Диски

**Data Mart Disk (20GB HDD)**
- Размер уменьшен из-за квот на диски
- Network-HDD для экономии квот
- Достаточно для базовых данных витрины
- Возможность расширения при увеличении квот

**Legacy DWH Disk (20GB HDD)**
- Размер уменьшен из-за квот на диски
- Network-HDD для экономии квот
- Достаточно для базовых данных
- Возможность расширения при увеличении квот

**Object Storage (2TB)**
- Хранение резервных копий и архивных данных
- Масштабируемое хранилище
- Экономичное решение для больших объёмов

### NAT Gateway

**Назначение:**
- Обеспечение доступа в интернет для приватных подсетей
- Безопасный выход в интернет без прямого доступа извне
- Централизованное управление исходящим трафиком

**Размещение:**
- В публичной подсети
- Доступ для всех приватных подсетей

## Параметры конфигурации

### Размеры виртуальных машин

**Малые VM (2 vCPU, 4GB RAM):**
- Portal, API Gateway, Event Bus
- Обоснование: Лёгкая нагрузка, веб-интерфейсы и маршрутизация

**Средние VM (4 vCPU, 8GB RAM):**
- ETL, Fintech
- Обоснование: Обработка данных и бизнес-логика требуют больше ресурсов

**Большие VM (8 vCPU, 16-32GB RAM):**
- AI Services, Data Mart
- Обоснование: Вычислительно-интенсивные задачи и аналитика

**Очень большие VM (16 vCPU, 64GB RAM):**
- Legacy DWH
- Обоснование: Поддержка существующей нагрузки и больших объёмов данных

### Размеры дисков

**30-50GB для системных дисков:**
- Достаточно для ОС и базовых приложений
- Возможность расширения при необходимости

**100-200GB для серверов приложений:**
- Логи, временные файлы, кэш
- Зависит от типа сервиса

**500GB-1TB для баз данных:**
- Хранение данных витрины и DWH
- SSD для высокой производительности

**2TB для Object Storage:**
- Резервные копии и архивы
- Масштабируемое хранилище

### Настройки NAT

**NAT Gateway в публичной подсети:**
- Обеспечивает доступ в интернет для приватных подсетей
- Безопасный выход без прямого доступа извне
- Централизованное управление трафиком

## Причины использования декларативного подхода

### Infrastructure as Code (IaC)

**Преимущества:**
1. **Версионирование:** Инфраструктура версионируется как код
2. **Воспроизводимость:** Одинаковая инфраструктура в разных средах
3. **Повторяемость:** Автоматическое создание идентичной инфраструктуры
4. **Документирование:** Код является документацией
5. **Безопасность:** Контроль изменений через code review

**Сравнение с императивным подходом:**
- Императивный: Ручные команды, сложность воспроизведения
- Декларативный: Описание желаемого состояния, автоматическое достижение

### Terraform как инструмент

**Преимущества Terraform:**
1. **Мультипровайдер:** Поддержка различных облачных провайдеров
2. **Планирование:** Предварительный просмотр изменений (terraform plan)
3. **Состояние:** Управление состоянием инфраструктуры
4. **Модульность:** Переиспользование конфигураций
5. **Сообщество:** Большая экосистема модулей

## Воспроизводимость инфраструктуры

### Одинаковая инфраструктура в разных средах

**Dev, Staging, Production:**
- Одинаковая структура, разные параметры
- Использование переменных для различий
- Снижение рисков при развёртывании

**Преимущества:**
- Меньше ошибок при развёртывании
- Быстрое создание новых сред
- Упрощённое тестирование

### Масштабируемость

**Горизонтальное масштабирование:**
- Добавление новых VM через копирование конфигурации
- Использование модулей для типовых компонентов
- Автоматическое масштабирование через Kubernetes (следующий этап)

**Вертикальное масштабирование:**
- Изменение параметров VM в конфигурации
- Применение изменений через terraform apply
- Минимальное время простоя

**Автоматизация:**
- Интеграция с CI/CD процессами
- Автоматическое развёртывание при изменениях
- Откат изменений через версионирование

## Безопасность

### Изоляция сетей

**Публичные и приватные подсети:**
- Критичные сервисы в приватных подсетях
- Минимальный доступ из интернета
- NAT Gateway для безопасного доступа в интернет

### Управление доступом

**SSH ключи:**
- Использование SSH ключей вместо паролей
- Централизованное управление доступом
- Безопасное подключение к серверам

### Резервное копирование

**Диски и хранилища:**
- Автоматическое резервное копирование дисков
- Object Storage для архивов
- Восстановление через Terraform

## Экономическая эффективность

### Оптимизация ресурсов

**Правильный выбор размеров:**
- Не завышенные ресурсы снижают затраты
- Масштабирование при необходимости
- Оптимизация под реальную нагрузку

### Управление жизненным циклом

**Автоматизация:**
- Снижение затрат на ручное управление
- Быстрое создание и удаление ресурсов
- Оптимизация использования ресурсов

## Соответствие бизнес-требованиям

### Масштабирование для новых бизнесов

**Гибкая архитектура:**
- Легкое добавление новых VM
- Использование модулей для типовых компонентов
- Быстрое развёртывание новых сервисов

### Независимое развитие доменов

**Изоляция подсетей:**
- Разные домены в разных подсетях
- Минимальная зависимость между доменами
- Безопасная коммуникация

### Высокая доступность

**Отказоустойчивость:**
- Возможность создания в нескольких зонах
- Резервное копирование данных
- Быстрое восстановление через Terraform

